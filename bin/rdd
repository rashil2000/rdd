#!/usr/bin/env node

const fs = require('fs')
const nopt = require('nopt')
const opn = require('opn')
const path = require('path')
const server = require('../server')
const markdownExtensions = require('markdown-extensions')

const logError = function(message) {
  console.error('rdd: ' + message)
  return process.exit(1)
}

const knownOptions = {
  open: Boolean,
  port: Number,
  usage: Boolean
}
const shortHands = {
  o: '--open',
  p: '--port',
  h: '--help'
}
const options = nopt(knownOptions, shortHands)

if (options.help) {
  return fs
    .createReadStream(path.join(__dirname, 'usage.txt'))
    .pipe(process.stdout)
}

const port = options.port || 8888
const url = 'http://localhost:' + port + '/'

let file = options.argv.remain[0]
if (file) {
  if (!fs.existsSync(file)) {
    return logError(file + ': No such file')
  }
} else {
  const regExp = new RegExp(
    '^readme.(' + markdownExtensions.join('|') + ')$',
    'i'
  )
  file = fs.readdirSync(process.cwd()).reduce(function(foundFile, file) {
    if (foundFile) {
      return foundFile
    }
    if (regExp.test(file)) {
      return file
    }
  }, null)
  if (!file) {
    return logError('Need a file')
  }
}

server(file, port, logError)
console.log('Serving on localhost:' + port)

if (options.open) {
  opn(url + file)
}
